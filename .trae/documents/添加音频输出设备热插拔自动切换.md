## 音频输出定位
- 输出后端：桌面平台使用 OpenAL（mojoAL），SDL 主要用于窗口与事件循环。
- 设备初始化：`src/lime/media/AudioManager.hx:36–40` 在 `OPENAL` 分支中调用 `ALC.openDevice(null)` → `ALC.createContext(...)` → `ALC.makeContextCurrent(...)`。
- PCM写入：`project/src/media/openal/OpenALBindings.cpp:318–324` 的 `lime_al_buffer_data(...)` 调用 `alBufferData(...)` 把音频数据写入缓冲。
- 触发播放：`project/src/media/openal/OpenALBindings.cpp:2581–2594` 的 `lime_al_source_play(...)`/`hl_al_source_play(...)` 调用 `alSourcePlay(...)`。
- 相关封装：`src/lime/media/openal/ALC.hx:164–176` 的 `openDevice(...)`、`getString(...)`；`src/lime/media/openal/AL.hx` 封装 `bufferData(...)`、`sourcePlay(...)`。

## 目标
- 当系统默认音频输出设备发生变化（或设备拔插），自动切换到新的默认输出设备，尽量无感或最小化中断。

## 总体方案
- 设备变化检测：跨平台优先用 OpenAL 的默认设备查询；如可用则定时轮询默认设备名，检测变化。
- 切换策略：在检测到变化时，暂停当前设备与上下文，销毁旧上下文与设备，重新打开新的默认设备并恢复播放。
- 事件来源（可选增强）：在 SDL 事件循环中处理 `SDL_AUDIODEVICEADDED / SDL_AUDIODEVICEREMOVED`，作为立即触发的辅助信号；依旧以 OpenAL 重建为核心。

## 具体修改点
- 新增 CFFI 绑定：
  - 在 `project/src/media/openal/OpenALBindings.cpp` 里新增 `lime_alc_get_string_global(int param)`，底层调用 `alcGetString(NULL, param)`，用于读取 `ALC.DEFAULT_DEVICE_SPECIFIER` 与枚举扩展。
  - 在 `src/lime/_internal/backend/native/NativeCFFI.hx` 与 `src/lime/media/openal/ALC.hx` 暴露 `getDefaultDeviceName():String` 与可选 `enumerateAllDevices():Array<String>`。
- 设备轮询与切换逻辑：
  - 在 `src/lime/media/AudioManager.hx` 增加一个轻量 `Timer`（如 500–1000ms）定时检查默认设备名变化：
    - 读取当前上下文设备名：`ALC.getString(currentDevice, ALC.DEVICE_SPECIFIER)`。
    - 对比全局默认设备名：`getDefaultDeviceName()`；若不一致则触发切换。
  - 提供 API：`AudioManager.switchToDefaultOutput():Void` 与 `AudioManager.switchToDevice(name:String):Bool`：
    - 执行顺序：`alc.suspendContext(ctx)` → `alc.pauseDevice(dev)` → `alc.makeContextCurrent(null)` → `alc.destroyContext(ctx)` → `alc.closeDevice(dev)` → `alc.openDevice(name/null)` → `alc.createContext(...)` → `alc.makeContextCurrent(...)` → `alc.processContext(...)`。
- SDL 事件辅助（可选）：
  - 在 `project/src/backend/sdl/SDLApplication.cpp` 的 `HandleEvent(...)` switch 中新增 `SDL_AUDIODEVICEADDED/SDL_AUDIODEVICEREMOVED` 分支，触发到 Haxe 层的回调（如 `System.onAudioDeviceChange`），再调用 `AudioManager.switchToDefaultOutput()`。

## 恢复与兼容细节
- 最小化中断：切换前使用 `alcDevicePauseSOFT/alcSuspendContext`，切换后 `alcProcessContext/alcResumeDevice` 恢复；允许 1–2 帧的可接受停顿。
- 资源重建：OpenAL 的 `ALSource/ALBuffer` 隶属于上下文；销毁后需由上层音频播放器/引擎重建或重新队列流数据。若项目使用 Lime/OpenFL 的 `SoundChannel`，在切换完成后调用一次内部重建钩子（新增一个 `AudioManager.onDeviceSwitched` 通知，驱动上层重新初始化播放单元）。
- 回退策略：若新设备打开失败，回退到旧设备或静音，持续轮询直至可用。

## 测试与验证
- 单元场景：持续播放一段循环音频，定期变更 Windows 默认播放设备（耳机↔扬声器），观察是否自动切换且仅有极短暂的停顿。
- 边界：移除当前设备；插入新设备但默认设备不变；快速拔插；设备采样率变化。
- 跨平台：Windows 首先验证；macOS 使用 CoreAudio 的默认设备变化也能通过默认设备名轮询生效；Linux 依赖 OpenAL 后端枚举。

## 风险与注意
- 设备枚举与默认设备读取需依赖 `alcGetString(NULL, ...)`；因此新增 CFFI 绑定是关键。
- 若现有项目在 Haxe 层自行管理 OpenAL 对象（自定义播放器），需在 `onDeviceSwitched` 里同步重建，防止悬空句柄。
- SDL 事件在不同平台对输出设备支持程度不一致，作为加速信号而非唯一依据。

## 交付
- 修改上述文件并提供可开关的配置（如 `AudioManager.enableHotplug = true`，默认启用）。
- 自测脚本与说明：如何在 Windows 切换默认设备并观察效果。